import { ScrollView, View } from "react-native";
import { eachDayOfInterval, format } from "date-fns";
import { useContext, useEffect, useMemo, useState } from "react";

import AsyncStorage from "@react-native-async-storage/async-storage";
import { DaySection } from "../../../../components/meal-plan/day-section";
import { MealPlanContext } from "../../../../context/meal-plan-context";
import { SafeAreaView } from "../../../../components/safe-area-view";
import { UserDropdown } from "../../../../components/user-dropdown";
import { WeekSelector } from "../../../../components/week-selector";

type MealPlan = any; // TODO: update with real type
type FoodEntry = any; // TODO: replace with real type

export default function MealPlanScreen() {
	const [loading, setLoading] = useState(false);
	const [mealPlan, setMealPlan] = useState<MealPlan | null>(null);
	const [error, setError] = useState<string | null>(null);
	const { startDate, endDate, viewThisWeek, viewNext, viewPrevious } =
		useContext(MealPlanContext);

	const [users, setUsers] = useState([
		{
			userId: "testing",
			name: "David Sessoms",
			avatarUrl:
				"data:image/jpeg;base64,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",
			isSelected: true,
		},
		{
			userId: "testing2",
			name: "Milena Souto",
			avatarUrl:
				"data:image/jpeg;base64,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",
			isSelected: true,
		},
	]);

	const onUserToggle = (userId: string) => {
		const newUserArray = [...users];
		const userIndex = newUserArray.findIndex((user) => user.userId === userId);
		newUserArray[userIndex].isSelected = !newUserArray[userIndex].isSelected;
		setUsers(newUserArray);
	};

	// Load meal plan from storage on mount
	useEffect(() => {
		(async () => {
			const stored = await AsyncStorage.getItem("mealPlan");
			if (stored) {
				try {
					setMealPlan(JSON.parse(stored));
				} catch {}
			}
		})();
	}, []);

	// Save meal plan to storage when it changes
	useEffect(() => {
		if (mealPlan) {
			AsyncStorage.setItem("mealPlan", JSON.stringify(mealPlan));
		}
	}, [mealPlan]);

	const recipeEntriesByDay = useMemo(() => {
		const finalMap: { [key: string]: NonNullable<FoodEntry>[] } = {};
		mealPlan?.foodEntries.forEach((entry: FoodEntry) => {
			const dateString = format(entry.date, "yyyy-MM-dd");
			if (finalMap[dateString]) {
				finalMap[dateString].push(entry);
			} else {
				finalMap[dateString] = [entry];
			}
		});
		return finalMap;
	}, [mealPlan?.foodEntries]);

	const weekDates = eachDayOfInterval({
		start: startDate,
		end: endDate,
	});

	return (
		<SafeAreaView className="flex flex-1">
			<View className="flex flex-1 p-2">
				<View className="flex flex-row justify-between pb-4">
					<UserDropdown users={users} onUserToggle={onUserToggle} />
					<WeekSelector
						startDate={startDate}
						endDate={endDate}
						onPreviousClick={viewPrevious}
						onNextClick={viewNext}
						onThisWeek={viewThisWeek}
					/>
					<View></View>
				</View>
				<ScrollView
					contentContainerStyle={{ padding: 16, flexGrow: 1 }}
					style={{ flex: 1 }}
				>
					{weekDates.map((date) => {
						const dateString = format(date, "yyyy-MM-dd");
						return (
							<DaySection
								key={dateString}
								date={date}
								recipeEntries={recipeEntriesByDay[dateString]}
								onAdd={() => null}
							/>
						);
					})}
				</ScrollView>
			</View>
		</SafeAreaView>
	);
}
